name: Reusable - Build & Test

on:
  workflow_call:
    inputs:
      run_commitlint:
        type: boolean
        required: false
        default: true
      base_sha:
        type: string
        required: false
      head_sha:
        type: string
        required: false

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:8
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      MONGODB_URI: mongodb://127.0.0.1:27017/byteroute_test
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.30.3

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.14.0
          cache: pnpm

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version: 1.26.0

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Lint commits (Conventional Commits)
        if: ${{ inputs.run_commitlint }}
        shell: bash
        env:
          BASE_SHA: ${{ inputs.base_sha }}
          HEAD_SHA: ${{ inputs.head_sha }}
        run: |
          set -euo pipefail

          # Prefer inputs from the caller workflow; otherwise fall back to sensible defaults.
          BASE_SHA="${BASE_SHA:-}"
          HEAD_SHA="${HEAD_SHA:-${GITHUB_SHA}}"

          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]] || ! git rev-parse --verify "$BASE_SHA^{commit}" >/dev/null 2>&1; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BASE_SHA="HEAD^"
            else
              BASE_SHA="HEAD"
            fi
          fi

          pnpm exec commitlint --from "$BASE_SHA" --to "$HEAD_SHA" --verbose

      - name: Lint
        run: pnpm -w lint

      - name: Install libpcap for Go tests
        run: sudo apt-get update && sudo apt-get install -y libpcap-dev

      - name: Build Go client (Docker)
        run: |
          cd apps/client-go
          docker build -f Dockerfile.static -t byteroute-client-builder .
          docker create --name byteroute-temp byteroute-client-builder
          mkdir -p build
          docker cp byteroute-temp:/byteroute-client build/byteroute-client
          docker rm byteroute-temp

      - name: Build
        run: pnpm -w build

      - name: Test Go client with coverage
        run: |
          cd apps/client-go
          pnpm coverage

      - name: Convert Go coverage to Cobertura
        run: |
          go install github.com/boumenot/gocover-cobertura@v1.2.0
          cd apps/client-go
          "$(go env GOPATH)/bin/gocover-cobertura" < coverage.out > coverage.cobertura.xml

      - name: Upload Go coverage
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-go
          path: |
            apps/client-go/coverage.out
            apps/client-go/coverage.cobertura.xml
          retention-days: 30

      - name: Test
        run: pnpm -w coverage

      - name: Upload coverage reports to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

      - name: Code Coverage Summary
        uses: irongut/CodeCoverageSummary@v1.3.0
        with:
          filename: coverage/apps-backend/cobertura-coverage.xml,apps/client-go/coverage.cobertura.xml
          badge: true
          format: markdown
          indicators: true
          output: both

      - name: Add coverage summary to workflow summary
        if: always()
        run: |
          if [ -f code-coverage-results.md ]; then
            cat code-coverage-results.md >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Upload coverage reports
        uses: actions/upload-artifact@v6
        if: always()
        with:
          name: coverage-reports
          path: |
            coverage/
            code-coverage-results.md
          retention-days: 30
