name: Reusable - Build & Test

on:
  workflow_call:
    inputs:
      run_commitlint:
        type: boolean
        required: false
        default: true
      base_sha:
        type: string
        required: false
      head_sha:
        type: string
        required: false

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      mongo:
        image: mongo:8
        ports:
          - 27017:27017
        options: >-
          --health-cmd="mongosh --eval 'db.runCommand({ ping: 1 })'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    env:
      MONGODB_URI: mongodb://127.0.0.1:27017/byteroute_test
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.28.2

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: 24.13.0
          cache: pnpm

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Lint commits (Conventional Commits)
        if: ${{ inputs.run_commitlint }}
        shell: bash
        env:
          BASE_SHA: ${{ inputs.base_sha }}
          HEAD_SHA: ${{ inputs.head_sha }}
        run: |
          set -euo pipefail

          # Prefer inputs from the caller workflow; otherwise fall back to sensible defaults.
          BASE_SHA="${BASE_SHA:-}"
          HEAD_SHA="${HEAD_SHA:-${GITHUB_SHA}}"

          if [[ -z "$BASE_SHA" || "$BASE_SHA" == "0000000000000000000000000000000000000000" ]] || ! git rev-parse --verify "$BASE_SHA^{commit}" >/dev/null 2>&1; then
            if git rev-parse HEAD^ >/dev/null 2>&1; then
              BASE_SHA="HEAD^"
            else
              BASE_SHA="HEAD"
            fi
          fi

          pnpm exec commitlint --from "$BASE_SHA" --to "$HEAD_SHA" --verbose

      - name: Lint
        run: pnpm -w lint

      - name: Build Go client (Docker)
        run: |
          cd apps/client-go
          docker build -f Dockerfile.static -t byteroute-client-builder .
          docker create --name byteroute-temp byteroute-client-builder
          mkdir -p build
          docker cp byteroute-temp:/byteroute-client build/byteroute-client
          docker rm byteroute-temp

      - name: install maxminddb
        env:
          MAXMIND_API_KEY: ${{ secrets.MAXMIND_API_KEY }}
          MAXMIND_USER_ID: ${{ secrets.MAXMIND_USER_ID }}
        run: |
          cd apps/backend
          node scripts/update-maxmind.mjs

      - name: Test
        run: pnpm -w test

      - name: Build
        run: pnpm -w build
