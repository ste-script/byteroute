services:
  traefik:
    image: traefik:v3.6
    container_name: byteroute-traefik
    restart: unless-stopped
    command:
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
    ports:
      # Single public entrypoint for dashboard + API + Socket.IO
      - "${TRAEFIK_PORT:-8080}:80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - traefik

  mongodb:
    image: mongo:8
    container_name: byteroute-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_DATABASE: byteroute
    volumes:
      - mongodb_data:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "--quiet", "--eval", "db.runCommand({ ping: 1 }).ok"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - internal

  backend:
    image: ghcr.io/ste-script/byteroute-backend:latest
    container_name: byteroute-backend
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: "3000"
      MONGODB_URI: mongodb://mongodb:27017/byteroute
      # Required by the backend entrypoint (downloads GeoLite2 databases on start)
      MAXMIND_USER_ID: ${MAXMIND_USER_ID:?set in .env}
      MAXMIND_API_KEY: ${MAXMIND_API_KEY:?set in .env}
      JWT_SECRET: ${JWT_SECRET:?set in .env}
    labels:
      - traefik.enable=true
      # Route REST API + Socket.IO to backend
      - traefik.http.routers.byteroute-api.rule=PathPrefix(`/api`) || PathPrefix(`/socket.io`) || PathPrefix(`/auth`) || Path(`/health`)
      - traefik.http.routers.byteroute-api.entrypoints=web
      - traefik.http.routers.byteroute-api.priority=100
      - traefik.http.routers.byteroute-api.service=byteroute-backend
      - traefik.http.services.byteroute-backend.loadbalancer.server.port=3000
    networks:
      - internal
      - traefik

  dashboard:
    image: ghcr.io/ste-script/byteroute-dashboard:latest
    container_name: byteroute-dashboard
    restart: unless-stopped
    depends_on:
      - backend
    labels:
      - traefik.enable=true
      # Route everything else to the SPA
      - traefik.http.routers.byteroute-ui.rule=PathPrefix(`/`)
      - traefik.http.routers.byteroute-ui.entrypoints=web
      - traefik.http.routers.byteroute-ui.priority=1
      - traefik.http.routers.byteroute-ui.service=byteroute-dashboard
      - traefik.http.services.byteroute-dashboard.loadbalancer.server.port=80
    networks:
      - traefik

volumes:
  mongodb_data:

networks:
  traefik:
  internal:
